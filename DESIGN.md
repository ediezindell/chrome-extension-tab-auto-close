### **設計案**

このChrome拡張機能は、主に以下の3つのコンポーネントで構成されます。

1.  **バックグラウンドスクリプト (`background.ts`)**
    *   **役割:** 拡張機能の中核として、常にバックグラウンドで動作します。
    *   **処理内容:**
        *   タブの状態変化を監視します (`chrome.tabs.onUpdated` APIを利用)。
        *   タブの読み込みが完了したタイミングで、そのタブのURLが対象（例: `slack.com`）かどうかを簡易的に判定します。
        *   対象の可能性がある場合、設定（`chrome.storage`）を読み込み、そのアプリの自動クローズ機能がONになっているか確認します。
        *   機能がONの場合、**コンテントスクリプト**をそのタブに注入（inject）します。
        *   **コンテントスクリプト**から「タブを閉じてください」というメッセージを受け取ったら、該当のタブを閉じます (`chrome.tabs.remove`)。
        *   拡張機能のアイコンがクリックされた際に、オプションページを開きます (`chrome.runtime.openOptionsPage`)。

2.  **コンテントスクリプト (`content.ts`)**
    *   **役割:** 実際のWebページに埋め込まれ、そのページのDOMにアクセスします。
    *   **処理内容:**
        *   バックグラウンドスクリプトによって注入された後、`MutationObserver`を初期化し、`document.body`への変更（要素の追加・削除など）の監視を開始します。
        *   同時に、監視を自動で停止するためのタイマー（例: 5秒）をセットします (`setTimeout`)。これは、無関係なページで監視が永遠に続いてしまうのを防ぐためです。
        *   DOMに変更が加わるたび、または初期読み込み時に、ページ内のテキストにキーワードが含まれているかをチェックします。
        *   キーワードを発見した場合:
            1.  `MutationObserver`を停止します (`disconnect`)。
            2.  タイマーを解除します (`clearTimeout`)。
            3.  バックグラウンドスクリプトに「タブを閉じてください」というメッセージを送信します。
        *   キーワードが見つからないままタイマーが時間切れになった場合:
            1.  `MutationObserver`を停止し、そのページでの監視を終了します。

3.  **オプションページ (`options.tsx` & `options.html`)**
    *   **役割:** ユーザーが設定を変更するためのUIを提供します。
    *   **処理内容:**
        *   `chrome.storage` APIを利用して、現在の設定値（各アプリのON/OFF状態）を読み込み、トグルスイッチの表示に反映させます。
        *   ユーザーがトグルスイッチを操作したら、その新しい設定値を`chrome.storage`に保存します。

---

#### **処理フローのまとめ**

1.  ユーザーがSlackのリンクを開く。
2.  **バックグラウンドスクリプト**がタブの更新を検知。
3.  設定でSlackがONになっていることを確認し、そのタブに**コンテントスクリプト**を注入。
4.  **コンテントスクリプト**が`MutationObserver`でDOMを監視し、「デスクトップアプリにリダイレクトしました」というテキストを発見。
5.  **コンテントスクリプト**が**バックグラウンドスクリプト**に「閉じて」とメッセージを送信。
6.  **バックグラウンドスクリプト**がメッセージを受け取り、タブを閉じる。
